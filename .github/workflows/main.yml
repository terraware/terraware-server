name: seedbank-server

on:
  push:
    branches:
      - main
      - wip-*
  pull_request:

jobs:
  build:
    runs-on: ubuntu-20.04

    strategy:
      matrix:
        java-version: ["11", "15"]

    steps:
    - uses: actions/checkout@v2

    - name: Set up Java ${{ matrix.java-version }}
      uses: actions/setup-java@v1
      with:
        java-version: ${{ matrix.java-version }}

    - name: Cache dependencies
      id: cache-gradle
      uses: actions/cache@v2
      with:
        path: |
          ~/.gradle
          ~/.m2
        key: 2-${{ matrix.java-version }}-${{ hashFiles('*.gradle.kts') }}

    # The build/test process is broken out into individual steps here so it's easier to watch
    # the progress of the build in the GitHub UI and so it's clearer what failed if the build
    # has problems; locally, "./gradlew check" will do all this in a single command.

    - name: Download dependencies
      run: |
        docker pull postgres:12
        ./gradlew downloadDependencies

    - name: Check code style
      run: ./gradlew spotlessCheck

    - name: Generate jOOQ classes
      run: ./gradlew generateJooqMetamodel

    - name: Compile main
      run: ./gradlew classes

    - name: Compile tests
      run: ./gradlew testClasses

    - name: Run tests
      run: ./gradlew test

    - name: Extract Docker image layers
      if: matrix.java-version == '15' && github.ref == 'refs/heads/main'
      run: make -C docker prepare

    - name: Set up Docker Buildx
      if: matrix.java-version == '15' && github.ref == 'refs/heads/main'
      uses: docker/setup-buildx-action@v1

    - name: Log into Docker Hub
      if: matrix.java-version == '15' && github.ref == 'refs/heads/main'
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Publish Docker image
      if: matrix.java-version == '15' && github.ref == 'refs/heads/main'
      uses: docker/build-push-action@v2
      with:
        context: build/docker
        tags: terraware/seedbank-server:latest
        platforms: linux/amd64,linux/arm64
        push: true
