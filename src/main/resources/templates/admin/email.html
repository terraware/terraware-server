<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
    <style>
        #quill-editor {
            height: 300px;
        }
    </style>
</head>

<body>
<span th:replace="~{/admin/header :: top}"/>
<a href="/admin/">Home</a>

<h2>Send Test Email</h2>

<form method="POST" action="/admin/sendEmail" th:if="${isEmailEnabled}">
    <label>
        Recipient
        <input type="email" name="recipient" id="recipient" required/>
    </label>
    <label>
        <input type="checkbox" id="sendToAll" name="sendToAll">
        Send to all users
    </label>
    <br/>
    <label>
        Email to Send
        <select name="emailName" id="emailName">
            <option th:value="DocumentsUpdate">Documents Update (EULA, TOS, Privacy update)</option>
            <option th:value="GenericEmail">Generic Email</option>
        </select>
    </label>
    <br/>
    <div id="genericEmailFields" style="display: none;">
        <label>
            Subject
            <input type="text" name="subject"/>
        </label>
        <br/>
        <label>Email Body</label>
        <div id="quill-editor"></div>
        <!-- Hidden textarea to store Quill content -->
        <textarea name="emailBody" id="emailBody" style="display: none;"></textarea>
        <br/>
    </div>
    <input type="submit" value=" Send Test Email "/>
</form>

<div th:if="${!isEmailEnabled}">
    <h3>The system is not configured to send emails.</h3>
</div>

<script>
    const sendToAllCheckbox = document.getElementById('sendToAll');
    const recipientInput = document.getElementById('recipient');
    const emailNameSelect = document.getElementById('emailName');
    const genericEmailFields = document.getElementById('genericEmailFields');
    let quillEditor = null;

    sendToAllCheckbox.addEventListener('change', function () {
        if (sendToAllCheckbox.checked) {
            recipientInput.removeAttribute('required');
            recipientInput.disabled = true;
        } else {
            recipientInput.setAttribute('required', true);
            recipientInput.disabled = false;
        }
    });

    emailNameSelect.addEventListener('change', function () {
        if (emailNameSelect.value === 'GenericEmail') {
            genericEmailFields.style.display = 'block';
            if (!quillEditor) {
                quillEditor = new Quill('#quill-editor', {
                    theme: 'snow',
                    modules: {
                        toolbar: [
                            [{'header': [1, 2, 3, false]}],
                            ['bold', 'italic', 'underline', 'strike'],
                            [{'list': 'ordered'}, {'list': 'bullet'}],
                            [{'script': 'sub'}, {'script': 'super'}],
                            [{'color': []}, {'background': []}],
                            ['link'],
                            ['clean']
                        ]
                    },
                    placeholder: 'Compose your email here...'
                });

                // Update the hidden textarea when form is submitted
                document.querySelector('form').addEventListener('submit', function (e) {
                    document.querySelector('#emailBody').value = quillEditor.getSemanticHTML();
                });
            }
        } else {
            genericEmailFields.style.display = 'none';
        }
    });
</script>
</body>
</html>
