<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="/admin/header :: head">
    <style th:fragment="additionalStyle">
        table.bordered, table.bordered tr th, table.bordered tr td {
            border: 1px solid black;
        }

        table.bordered td, table.bordered th {
            padding: .25em;
        }

        label::before {
            content: '';
            display: block;
        }

        #map {
            width: 100%;
            height: 600px;
        }

        table#plotCounts input {
            text-align: right;
        }

        table#plotCounts td {
            text-align: right;
        }

        input[type="number"] {
            width: 5em;
        }
    </style>

    <th:block th:fragment="additionalScript">
        <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet">
        <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
        <script>
            function registerPlotCalculator(zoneId) {
                const errorMarginField = document.getElementById(`errorMargin-${zoneId}`);
                const permanentPlotsField = document.getElementById(`numPermanent-${zoneId}`);
                const permanent25PlotsField = document.getElementById(`numPermanent25-${zoneId}`);
                const studentsTField = document.getElementById(`studentsT-${zoneId}`);
                const temporaryPlotsField = document.getElementById(`numTemporary-${zoneId}`);
                const totalPlotsField = document.getElementById(`total25-${zoneId}`);
                const varianceField = document.getElementById(`variance-${zoneId}`);

                const recalculateTotalPlots = () => {
                    const permanentPlots = Number.parseFloat(permanentPlotsField.value) || 0;
                    const temporaryPlots = Number.parseFloat(temporaryPlotsField.value) || 0;

                    if (permanentPlots >= 0 && temporaryPlots >= 0) {
                        totalPlotsField.innerText = (permanentPlots * 4) + temporaryPlots;
                    }
                };

                const recalculateTemporaryPlots = () => {
                    const permanentPlots = Number.parseFloat(permanentPlotsField.value);

                    if (permanentPlots > 0) {
                        const temporaryPlots = Math.floor(permanentPlots * 4 / 3);
                        temporaryPlotsField.value = temporaryPlots;

                        recalculateTotalPlots();
                    }
                };

                const recalculatePermanentPlots = () => {
                    const errorMargin = Number.parseFloat(errorMarginField.value);
                    const studentsT = Number.parseFloat(studentsTField.value);
                    const variance = Number.parseFloat(varianceField.value);

                    if (errorMargin > 0 && studentsT > 0 && variance > 0) {
                        const permanentPlots = Math.ceil((studentsT * studentsT) * variance / errorMargin / errorMargin);

                        permanentPlotsField.value = permanentPlots;
                        permanent25PlotsField.innerText = permanentPlots * 4;

                        recalculateTemporaryPlots();
                    }
                };

                errorMarginField.addEventListener('change', recalculatePermanentPlots);
                studentsTField.addEventListener('change', recalculatePermanentPlots);
                varianceField.addEventListener('change', recalculatePermanentPlots);
                permanentPlotsField.addEventListener('change', recalculateTemporaryPlots);
                temporaryPlotsField.addEventListener('change', recalculateTotalPlots);
            }
        </script>
    </th:block>

</head>

<body>

<th:block th:include="/admin/header :: top"/>

<a th:href="|${prefix}/|">Home</a> -
<a th:href="|${prefix}/organization/${organization.id}|" th:text="${organization.name}">Org Name</a>

<h2 th:text="|Planting Site ${site.name} (${site.id})|">Planting Site Name (123)</h2>

<form method="POST" th:action="|${prefix}/updatePlantingSite|" th:if="${canUpdatePlantingSite}">
    <input type="hidden" name="plantingSiteId" th:value="${site.id}"/>
    <label for="siteName">Name</label>
    <input type="text" id="siteName" name="siteName" th:value="${site.name}" minlength="1"
           required/>
    <label for="description">Description</label>
    <input type="text" id="description" name="description" th:value="${site.description}"/>
    <br/>
    <input type="submit" value="Update"/>
</form>

<form method="POST" th:action="|${prefix}/movePlantingSite|" th:if="${canMovePlantingSiteToAnyOrg}"
      id="moveForm">
    <h3>Move to New Organization</h3>

    <p>
        <strong>WARNING!</strong> If you move a planting site, you will no longer be able to view it
        unless you are a member of the organization you're moving it to. Make sure you're done
        checking it for errors before you move it.
    </p>

    <input type="hidden" name="plantingSiteId" th:value="${site.id}"/>
    <label for="organizationId">Organization</label>
    <select id="organizationId" name="organizationId">
        <option th:each="org : ${allOrganizations}" th:value="${org.id}"
                th:text="|${org.name} (${org.id})|"
                th:selected="${org.id == organization.id}">
            My Org (123)
        </option>
    </select>
    <input type="submit" value="Move"/>
</form>

<th:div th:if="!${canUpdatePlantingSite}">
    Description:
    <th:block th:text="${site.description}"/>
</th:div>

<th:block th:if="!${site.plantingZones.isEmpty()}">

    <th:block th:if="${canUpdatePlantingSite}">
        <h3>Number of Monitoring Plots for Next Observation</h3>

        <table id="plotCounts">
            <tr>
                <th>Zone ID</th>
                <th>Name</th>
                <th>Variance</th>
                <th>Error</th>
                <th>Student's t</th>
                <th>Permanent<br/>(50x50)</th>
                <th>Temporary<br/>(25x25)</th>
                <th>Permanent<br/>(25x25)</th>
                <th>Total<br/>(25x25)</th>
                <th></th>
            </tr>

            <tr th:each="zone : ${site.plantingZones}">
                <td th:text="${zone.id}">1</td>
                <td th:text="${zone.name}">XYZ</td>
                <td>
                    <input type="number" step="0.001" name="variance" size="8" th:id="|variance-${zone.id}|"
                           th:value="${zone.variance}" th:form="|zone-${zone.id}|"/>
                </td>
                <td>
                    <input type="number" step="0.001" name="errorMargin" th:id="|errorMargin-${zone.id}|"
                           th:value="${zone.errorMargin}" th:form="|zone-${zone.id}|"/>
                </td>
                <td>
                    <input type="number" step="0.001" name="studentsT" th:id="|studentsT-${zone.id}|"
                           th:value="${zone.studentsT}" th:form="|zone-${zone.id}|"/>
                </td>
                <td>
                    <input type="number" name="numPermanent" th:id="|numPermanent-${zone.id}|"
                           th:value="${zone.numPermanentClusters}" th:form="|zone-${zone.id}|"/>
                </td>
                <td>
                    <input type="number" name="numTemporary" th:id="|numTemporary-${zone.id}|"
                           th:value="${zone.numTemporaryPlots}" th:form="|zone-${zone.id}|"/>
                </td>
                <td>
                    <span th:id="|numPermanent25-${zone.id}|"
                          th:text="${zone.numPermanentClusters != null ? zone.numPermanentClusters * 4 : ''}">
                        123
                    </span>
                </td>
                <td>
                    <span th:id="|total25-${zone.id}|"
                          th:text="${zone.numPermanentClusters != null || zone.numTemporaryPlots != null ? (zone.numPermanentClusters ?: 0) * 4 + (zone.numTemporaryPlots ?: 0) : ''}">
                        123
                    </span>
                </td>
                <td style="padding-left: 8px;">
                    <form method="POST" th:action="|${prefix}/updatePlantingZone|" th:id="|zone-${zone.id}|">
                        <input type="hidden" name="plantingSiteId" th:value="${site.id}"/>
                        <input type="hidden" name="plantingZoneId" th:value="${zone.id}"/>
                        <input type="submit" value="Update"/>
                    </form>
                    <script th:inline="javascript">
                        /*<![CDATA[*/
                        registerPlotCalculator(/*[[${zone.id}]]*/);
                        /*]]>*/
                    </script>
                </td>
            </tr>
        </table>
    </th:block>

    <h3>Site Map</h3>

    <div id="map"></div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        mapboxgl.accessToken = /*[[${mapboxToken}]]*/;

        const prefix = /*[[${prefix}]]*/;
        const envelope = /*[[${envelope}]]*/;
        const siteId = /*[[${site.id}]]*/;
        const bounds = new mapboxgl.LngLatBounds(envelope.coordinates[0][0], envelope.coordinates[0][2]);

        const map = new mapboxgl.Map({
            bounds: bounds,
            container: 'map',
            fitBoundsOptions: { padding: 10 },
            style: 'mapbox://styles/mapbox/satellite-streets-v12',
        });

        map.on('load', () => {
            map.addSource('site', {
                type: 'geojson',
                data: /*[[${siteGeoJson}]]*/,
            });

            map.addSource('zones', {
                type: 'geojson',
                data: /*[[${zonesGeoJson}]]*/,
            });

            map.addSource('subzones', {
                type: 'geojson',
                data: /*[[${subzonesGeoJson}]]*/,
            });

            map.addSource('plots', {
                type: 'geojson',
                data: `${prefix}/plantingSite/${siteId}/plots`,
            });

            map.addLayer({
                id: 'plots',
                type: 'line',
                source: 'plots',
                layout: {},
                paint: {
                    'line-color': [
                        'match',
                        ['get', 'permanent'],
                        'true',
                        'lightgreen',
                        'green',
                    ],
                }
            });

            map.addLayer({
                id: 'subzones',
                type: 'line',
                source: 'subzones',
                layout: {},
                paint: {
                    'line-color': 'grey',
                }
            });

            map.addLayer({
                id: 'zones',
                type: 'line',
                source: 'zones',
                layout: {},
                paint: {
                    'line-color': 'yellow',
                }
            });

            map.addLayer({
                id: 'zoneLabels',
                type: 'symbol',
                source: 'zones',
                layout: {
                    'text-field': ['get', 'name'],
                },
                paint: {
                    'text-color': 'yellow',
                    'text-halo-color': 'black',
                    'text-halo-width': 2,
                }
            });

            map.addLayer({
                id: 'site',
                type: 'line',
                source: 'site',
                layout: {},
                paint: {
                    'line-color': 'white',
                }
            });
        });
        /*]]>*/
    </script>

    <h3 th:text="|Planting Zones (${numPlantingZones}) and Subzones (${numSubzones}) and Monitoring Plots (${numPlots})|">
        Planting Zones (1) and Subzones (2) and Monitoring Plots (3)
    </h3>

    <ul>
        <li th:each="zone : ${site.plantingZones}">
            <th:block th:text="${zone.name}">Zone Name</th:block>

            <ul th:if="!${zone.plantingSubzones.isEmpty()}">
                <li th:each="subzone : ${zone.plantingSubzones}"
                    th:text="|${subzone.name} (${plotCounts[zone.id][subzone.id] ?: 0})|">
                    Subzone X (50)
                </li>
            </ul>
        </li>
    </ul>
</th:block>

<script th:if="${canMovePlantingSiteToAnyOrg}">
    document.getElementById('moveForm').addEventListener('submit', event => {
        const orgSelect = document.getElementById('organizationId');
        const orgName = orgSelect.options[orgSelect.selectedIndex].text;

        if (!confirm(`Are you sure you want to move the planting site to ${orgName}?`)) {
            event.preventDefault();
        }
    });
</script>
</body>
</html>
